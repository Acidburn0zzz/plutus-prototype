<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <style>
            * {
                font-family: Helvetica, sans-serif;
                font-size: 20px;
            }
            
            #header {
                background-color: black;
                padding: 10px;
                color: white;
                font-size: 50px;
                font-weight: bold;
            }
            
            #declarations {
                width: 600px;
                height: 150px;
                font-family: monospace;
            }
            
            #replout {
                width: 600px;
                height: 150px;
                font-family: monospace;
            }
            
            #expression {
                font-family: monospace;
                width: 600px;
            }
        </style>
        <script src="jquery-3.2.0.min.js"></script>
        <script src="Data.js"></script>
        <script src="Term.js"></script>
        <script src="CKMachine.js"></script>
        <script>
            
            $(document).ready(function () {
                $("#REPL").submit(function (ev) {
                    ev.preventDefault();
                    
                    let decls = $("#declarations").val();
                    let expr = $("#expression").val();
                    
                    $("#repl_input").val("");
                    
                    let req = {
                        "declarations": decls,
                        "expression": expr
                    };
                    
                    $.ajax({
                        type: "POST",
                        url: "api/compile",
                        data: JSON.stringify(req),
                        dataType: "json",
                        headers: {
                          "Accept": "application/json",
                          "Content-Type": "application/json"  
                        },
                        success: function (data, textStatus) {
                            if ("success" === textStatus) {
                                updateREPL(data);
                            } else {
                                replError(textStatus);
                            }
                        }
                    });
                });
            });
            
            function updateREPL(data) {
                let val = $("#replout").val();
                
                if ("" !== val) {
                    val += "\n\n------------------\n\n";
                }
                
                if ("Error" === data.responseText) {
                    
                    val += "Error when evaluating\n  " + $("#expression").val() +
                      "\n\n" + data.responseInfo;
                    
                } else if ("Ok" === data.responseText) {
                    
                    //val += data.responseInfo;
                    //val += show(eval("(" + data.responseInfo + ")"));
                    
                    let prog = eval("(" + data.responseInfo + ")");
                    val += cases(prog, {
                      Program: function (decls, expr) {
                          return cases(evaluate(declarationsToDeclEnv(decls),expr), {
                              
                             Left: function (err) {
                                 return "Error while evaluating term\n  " +
                                          prettyPrintTerm(expr) +
                                          "\n\n" +
                                          err;
                             },
                             
                             Right: function (res) {
                                 return "Expression to evaluate: " +
                                          $("#expression").val() +
                                        "\n\nParsed term to evaluate: " +
                                          prettyPrintTerm(expr) +
                                          "\n\n" +
                                          "Evaluated term: " +
                                          prettyPrintTerm(res);
                             }
                              
                          });
                      }
                    });
                    
                }
                
                $("#replout").val(val).scrollTop(100000);
                $("#expression").val("");
                
            }
            
            function replError(textStatus) {
                $("#replout").val("REPL Error: " + textStatus);
            }
            
            function loadExample1() {
                $("#declarations").val("data Boolean = { True | False }\n\nnot : Boolean -> Boolean {\n  not True = False ;\n  not False = True\n}\n\n\ndata List a = { Nil | Cons a (List a) }\n\nmap : forall a b. (a -> b) -> List a -> List b {\n  map f Nil = Nil ;\n  map f (Cons x xs) = Cons (f x) (map f xs)\n}")
            }
            
            function loadExample2() {
                $("#declarations").val("data P2PKH =\n  { P2PKH ByteString ByteString }\n\n\np2pkhCheck : P2PKH -> ByteString -> Boolean {\n  \n  p2pkhCheck (P2PKH pubKey sig) tx =\n  \n    and (equalByteString\n           (hash pubKey)\n           #1FdtUtvK5vZxwo8jzjzid5Ew)\n        \n        (verifySignature\n           pubKey\n           tx\n           sig)\n}\n\n\nvalidator : P2PKH -> Comp Unit {\n  validator info =\n    do tx <- transactionHash\n       case p2pkhCheck tx of {\n         True -> success UnitVal ;\n         False -> failure\n       }\n}\n\n\nredeemer : P2PKH {\n  redeemer = P2PKH myPubKey mySig\n}");
            }
            
            function declarationsToDeclEnv(decls) {
                let denv = {};
                
                for (let i = 0; i < decls.length; i++) {
                    let name = decls[i].args[0];
                    let val = decls[i].args[1];
                    denv[name] = val;
                }
                
                return denv;
            }
            
        </script>
    </head>
    <body>
        <div id="header"><img src="/iohk-logo.png" height="50px"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Try Plutus! (pre-alpha)</div>
        
        <p style="font-size: 50px;">http://138.68.142.152/</p>
        
        <p>Declarations:</p>
        <p><textarea id="declarations"></textarea></p>
        <p>
            <button onclick="loadExample1()">Example 1</button>
            <button onclick="loadExample2()">Example 2</button>
        </p>
        <hr/>
        <p>REPL:</p>
        <form id="REPL">
            <p><textarea id="replout" readonly></textarea></p>
            <p><input id="expression"></input></p>
        </form>
    </body>
</html>